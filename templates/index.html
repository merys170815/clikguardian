<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>ClickGuardian — Panel Anti Clicks Inválidos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root {
      --header-h: 65px;
      --controls-h: 60px;
      --bg: #0d1117;
      --panel:#111827;
      --muted:#9aa5b1;
      --accent:#2563eb;
    }

    body{
      margin:0;
      background:var(--bg);
      color:#e6edf3;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      overflow:hidden;
    }

    /* HEADER */
    header{
      position:fixed; top:0; left:0; right:0;
      height:var(--header-h);
      background:#0b1220;
      padding:12px 22px;
      border-bottom:1px solid #1e2637;
      z-index:1000;
      display:flex;
      flex-direction:column;
      justify-content:center;
    }

    h1{ margin:0; font-size:22px; font-weight:700; }
    .sub{ font-size:13px; opacity:.7; color:var(--muted); }

    /* CONTROLES */
    .controls{
      position:fixed;
      top:var(--header-h);
      left:0; right:0;
      height:var(--controls-h);
      z-index:999;
      display:flex;
      align-items:center;
      gap:12px;
      background:#0f172a;
      padding:10px 20px;
      border-bottom:1px solid #182234;
      box-shadow:0 2px 8px rgba(0,0,0,0.5);
    }

    input[type="text"]{
      padding:9px 12px;
      border-radius:6px;
      border:1px solid #23303b;
      background:#0a121d;
      color:#e6edf3;
      min-width:260px;
    }

    button{
      padding:9px 14px;
      border-radius:6px;
      border:1px solid #26313b;
      background:#1e293b;
      color:#e6edf3;
      cursor:pointer;
      font-weight:500;
    }

    button:hover{
      background:#32405a;
    }

    /* MENÚ DE COLUMNAS */
    #columnsBtn {
      background:#32405a;
      border:1px solid #3a4b63;
    }

    .cols-menu {
      position:absolute;
      top:115px;
      left:350px;
      background:#111827;
      border:1px solid #1e2637;
      border-radius:6px;
      padding:12px;
      display:none;
      flex-direction:column;
      gap:8px;
      z-index:2000;
      width:200px;
    }

    .cols-menu label {
      font-size:13px;
      color:#d5d8dd;
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }

    /* CONTENIDO SCROLLEABLE */
    .wrap{
      position:absolute;
      top: calc(var(--header-h) + var(--controls-h));
      left:0; right:0; bottom:0;
      overflow:auto;
      padding:20px 20px 40px;
    }

    /* TABLA */
    .table-wrap{
      border:1px solid #1e2637;
      border-radius:10px;
      overflow:auto;
      height: calc(100vh - var(--header-h) - var(--controls-h) - 40px);
    }

    table{
      width:100%;
      min-width:1150px;
      border-collapse:collapse;
    }

    th,td{
      padding:12px;
      border-bottom:1px solid #14202e;
      vertical-align:top;
      font-size:14px;
      white-space:nowrap;
      color:#dbe2ee;
    }

    thead th{
      position:sticky;
      top:0;
      background:#152238;
      font-weight:600;
      z-index:800;
      border-bottom:2px solid #1f2e45;
    }

    .badge{
      padding:4px 8px;
      border-radius:20px;
      font-size:12px;
      font-weight:600;
    }

    .badge.alto{
      background:#7f1d1d;
      color:#fecaca;
    }
    .badge.medio{
      background:#78350f;
      color:#fde68a;
    }
    .badge.bajo{
      background:#065f46;
      color:#a7f3d0;
    }

    .map-btn{
      padding:6px 10px;
      background:#10b981;
      color:#042f2e;
      border:none;
      border-radius:6px;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
    }

    .map-btn:hover{
      background:#059669;
    }

    .modal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      z-index:2000;
      align-items:center;
      justify-content:center;
    }

    .modal .box{
      width:90%;
      max-width:900px;
      height:70vh;
      background:#071018;
      border-radius:8px;
      border:1px solid #122028;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .modal .box .hdr{
      display:flex;
      justify-content:space-between;
      background:#0d1622;
      padding:12px 14px;
      font-weight:600;
    }

    #map{ flex:1; }

    .close{
      background:#1e293b;
      color:#fff;
      padding:6px 10px;
      border-radius:6px;
      border:none;
      cursor:pointer;
      font-weight:600;
    }

    .row-whatsapp {
      background-color: rgba(37, 211, 102, 0.12);
    }
    .row-whatsapp:hover {
      background-color: rgba(37, 211, 102, 0.22);
    }

    .row-blocked {
      background-color: rgba(239, 68, 68, 0.15) !important;
    }

    .row-blocked:hover {
      background-color: rgba(239, 68, 68, 0.25) !important;
    }

  </style>
</head>

<body>

<header>
  <h1>ClickGuardian</h1>
  <div class="sub">Sistema Profesional Anti Clicks Inválidos</div>
</header>

<div class="controls">
  <input id="search" type="text" placeholder="Buscar por IP, ciudad, ISP, evento…" />

  <label style="display:flex; gap:8px; color:var(--muted);">
    <input id="onlySuspicious" type="checkbox"/> Solo sospechosos
  </label>

  <button id="refresh">Actualizar</button>

  <!-- ✔ NUEVO botón columnas -->
  <button id="columnsBtn">Columnas ▾</button>

  <!-- ✔ MENÚ DE COLUMNAS -->
  <div id="columnsMenu" class="cols-menu">
    <label><input type="checkbox" data-col="0" checked> Fecha/Hora</label>
    <label><input type="checkbox" data-col="1" checked> IP</label>
    <label><input type="checkbox" data-col="2" checked> Device ID</label>
    <label><input type="checkbox" data-col="3" checked> Ciudad / Región / ISP</label>
    <label><input type="checkbox" data-col="4" checked> Evento</label>
    <label><input type="checkbox" data-col="5"> Ref</label>
    <label><input type="checkbox" data-col="6"> Origen</label>
    <label><input type="checkbox" data-col="7" checked> Dwell</label>
    <label><input type="checkbox" data-col="8" checked> Riesgo</label>
    <label><input type="checkbox" data-col="9" checked> Estado</label>
    <label><input type="checkbox" data-col="10" checked> Acción</label>
</div>

  <div style="margin-left:auto; color:var(--muted);" id="kpiSummary"></div>
</div>

<div class="wrap">
  <div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>Fecha/Hora</th>
        <th>IP</th>
        <th>Device ID</th>
        <th>Ciudad / Región / ISP</th>
        <th>Sitio</th>
        <th>Evento</th>
        <th>Ref</th>
        <th>Origen</th>
        <th>Dwell</th>
        <th>Riesgo</th>
        <th>Estado</th>
        <th>Acción</th>
      </tr>
    </thead>

    <tbody id="tbody"></tbody>
  </table>
</div>

</div>

<!-- MAPA -->
<div id="mapModal" class="modal">
  <div class="box">
    <div class="hdr">
      <div id="mapTitle" style="color:#e6edf3;">Ubicación</div>
      <div>
        <button id="zoomIn">+</button>
        <button id="zoomOut">-</button>
        <button id="closeMap" class="close">Cerrar</button>
      </div>
    </div>
    <div id="map"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://openfpcdn.io/fingerprintjs/v3"></script>

<script>
  let DEVICE_ID = null;

  async function initFingerprint() {
    const fp = await FingerprintJS.load();
    const result = await fp.get();
    DEVICE_ID = result.visitorId;
    window.DEVICE_ID = DEVICE_ID;
  }

  initFingerprint();
</script>

<!-- PANEL JS (tu script de backend) -->
<script src="/static/panel.js?v=5"></script>

<!-- ✔ SCRIPT PARA OCULTAR COLUMNAS -->
<script>
document.getElementById("columnsBtn").addEventListener("click", () => {
  const menu = document.getElementById("columnsMenu");
  menu.style.display = (menu.style.display === "flex") ? "none" : "flex";
});

document.querySelectorAll('#columnsMenu input[type="checkbox"]').forEach(cb => {
  cb.addEventListener("change", () => {
    const colIndex = cb.dataset.col;
    const show = cb.checked;

    // Mostrar/ocultar TH
    document.querySelectorAll("table th")[colIndex].style.display = show ? "" : "none";

    // Mostrar/ocultar TD
    document.querySelectorAll("table tbody tr").forEach(tr => {
      tr.children[colIndex].style.display = show ? "" : "none";
    });
  });
});
</script>

</body>
</html>
